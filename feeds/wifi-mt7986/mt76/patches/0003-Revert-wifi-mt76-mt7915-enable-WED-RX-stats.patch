From c76987bcdc45fb55119f23a32fd82f3b5f48b46e Mon Sep 17 00:00:00 2001
From: Brett Mastbergen <brettm@minim.com>
Date: Thu, 2 Mar 2023 10:50:02 -0500
Subject: [PATCH 3/7] Revert "wifi: mt76: mt7915: enable WED RX stats"

This reverts commit a887a5feb3d146c0b66e8e5b5d65886df4617925.
---
 mt76.h          |  6 ------
 mt7915/dma.c    |  6 ------
 mt7915/main.c   |  8 --------
 mt7915/mcu.c    | 18 ------------------
 mt7915/mmio.c   | 26 --------------------------
 mt7915/mt7915.h |  1 -
 6 files changed, 65 deletions(-)

diff --git a/mt76.h b/mt76.h
index 32a77a0a..64a43112 100644
--- a/mt76.h
+++ b/mt76.h
@@ -273,15 +273,9 @@ struct mt76_sta_stats {
 	u64 tx_nss[4];		/* 1, 2, 3, 4 */
 	u64 tx_mcs[16];		/* mcs idx */
 	u64 tx_bytes;
-	/* WED TX */
 	u32 tx_packets;
 	u32 tx_retries;
 	u32 tx_failed;
-	/* WED RX */
-	u64 rx_bytes;
-	u32 rx_packets;
-	u32 rx_errors;
-	u32 rx_drops;
 };
 
 enum mt76_wcid_flags {
diff --git a/mt7915/dma.c b/mt7915/dma.c
index 27b67800..db833867 100644
--- a/mt7915/dma.c
+++ b/mt7915/dma.c
@@ -361,18 +361,12 @@ static int mt7915_dma_enable(struct mt7915_dev *dev)
 
 	if (mtk_wed_device_active(&dev->mt76.mmio.wed)) {
 		u32 wed_irq_mask = irq_mask;
-		int ret;
 
 		wed_irq_mask |= MT_INT_TX_DONE_BAND0 | MT_INT_TX_DONE_BAND1;
 		if (!is_mt7986(&dev->mt76))
 			mt76_wr(dev, MT_INT_WED_MASK_CSR, wed_irq_mask);
 		else
 			mt76_wr(dev, MT_INT_MASK_CSR, wed_irq_mask);
-
-		ret = mt7915_mcu_wed_enable_rx_stats(dev);
-		if (ret)
-			return ret;
-
 		mtk_wed_device_start(&dev->mt76.mmio.wed, wed_irq_mask);
 	}
 
diff --git a/mt7915/main.c b/mt7915/main.c
index 2505fa7e..a2706332 100644
--- a/mt7915/main.c
+++ b/mt7915/main.c
@@ -1034,14 +1034,6 @@ static void mt7915_sta_statistics(struct ieee80211_hw *hw,
 
 		sinfo->tx_retries = msta->wcid.stats.tx_retries;
 		sinfo->filled |= BIT_ULL(NL80211_STA_INFO_TX_RETRIES);
-
-		if (mtk_wed_get_rx_capa(&phy->dev->mt76.mmio.wed)) {
-			sinfo->rx_bytes = msta->wcid.stats.rx_bytes;
-			sinfo->filled |= BIT_ULL(NL80211_STA_INFO_RX_BYTES64);
-
-			sinfo->rx_packets = msta->wcid.stats.rx_packets;
-			sinfo->filled |= BIT_ULL(NL80211_STA_INFO_RX_PACKETS);
-		}
 	}
 
 	sinfo->ack_signal = (s8)msta->ack_signal;
diff --git a/mt7915/mcu.c b/mt7915/mcu.c
index b2835d9c..b7d778bc 100644
--- a/mt7915/mcu.c
+++ b/mt7915/mcu.c
@@ -1689,24 +1689,6 @@ out:
 				     MCU_EXT_CMD(STA_REC_UPDATE), true);
 }
 
-int mt7915_mcu_wed_enable_rx_stats(struct mt7915_dev *dev)
-{
-#ifdef CONFIG_NET_MEDIATEK_SOC_WED
-	struct mtk_wed_device *wed = &dev->mt76.mmio.wed;
-	struct {
-		__le32 args[2];
-	} req = {
-		.args[0] = cpu_to_le32(1),
-		.args[1] = cpu_to_le32(6),
-	};
-
-	return mtk_wed_device_update_msg(wed, MTK_WED_WO_CMD_RXCNT_CTRL,
-					 &req, sizeof(req));
-#else
-	return 0;
-#endif
-}
-
 int mt7915_mcu_add_dev_info(struct mt7915_phy *phy,
 			    struct ieee80211_vif *vif, bool enable)
 {
diff --git a/mt7915/mmio.c b/mt7915/mmio.c
index 3b4ede3b..cfdbe890 100644
--- a/mt7915/mmio.c
+++ b/mt7915/mmio.c
@@ -664,31 +664,6 @@ unmap:
 	mt7915_wed_release_rx_buf(wed);
 	return -ENOMEM;
 }
-
-static void mt7915_mmio_wed_update_rx_stats(struct mtk_wed_device *wed,
-					    struct mtk_wed_wo_rx_stats *stats)
-{
-	int idx = le16_to_cpu(stats->wlan_idx);
-	struct mt7915_dev *dev;
-	struct mt76_wcid *wcid;
-
-	dev = container_of(wed, struct mt7915_dev, mt76.mmio.wed);
-
-	if (idx >= mt7915_wtbl_size(dev))
-		return;
-
-	rcu_read_lock();
-
-	wcid = rcu_dereference(dev->mt76.wcid[idx]);
-	if (wcid) {
-		wcid->stats.rx_bytes += le32_to_cpu(stats->rx_byte_cnt);
-		wcid->stats.rx_packets += le32_to_cpu(stats->rx_pkt_cnt);
-		wcid->stats.rx_errors += le32_to_cpu(stats->rx_err_cnt);
-		wcid->stats.rx_drops += le32_to_cpu(stats->rx_drop_cnt);
-	}
-
-	rcu_read_unlock();
-}
 #endif
 
 int mt7915_mmio_wed_init(struct mt7915_dev *dev, void *pdev_ptr,
@@ -770,7 +745,6 @@ int mt7915_mmio_wed_init(struct mt7915_dev *dev, void *pdev_ptr,
 	wed->wlan.offload_disable = mt7915_mmio_wed_offload_disable;
 	wed->wlan.init_rx_buf = mt7915_wed_init_rx_buf;
 	wed->wlan.release_rx_buf = mt7915_wed_release_rx_buf;
-	wed->wlan.update_wo_rx_stats = mt7915_mmio_wed_update_rx_stats;
 
 	dev->mt76.rx_token_size = wed->wlan.rx_npkt;
 
diff --git a/mt7915/mt7915.h b/mt7915/mt7915.h
index 42f21343..417c62e3 100644
--- a/mt7915/mt7915.h
+++ b/mt7915/mt7915.h
@@ -634,7 +634,6 @@ void mt7915_set_stream_vht_txbf_caps(struct mt7915_phy *phy);
 void mt7915_update_channel(struct mt76_phy *mphy);
 int mt7915_mcu_muru_debug_set(struct mt7915_dev *dev, bool enable);
 int mt7915_mcu_muru_debug_get(struct mt7915_phy *phy, void *ms);
-int mt7915_mcu_wed_enable_rx_stats(struct mt7915_dev *dev);
 int mt7915_init_debugfs(struct mt7915_phy *phy);
 void mt7915_debugfs_rx_fw_monitor(struct mt7915_dev *dev, const void *data, int len);
 bool mt7915_debugfs_rx_log(struct mt7915_dev *dev, const void *data, int len);
-- 
2.30.2

